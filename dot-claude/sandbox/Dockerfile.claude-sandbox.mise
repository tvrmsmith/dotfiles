FROM docker/sandbox-templates:claude-code

USER root

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Configure mise environment variables for Docker
ENV MISE_DATA_DIR="/mise"
ENV MISE_CONFIG_DIR="/mise"
ENV MISE_CACHE_DIR="/mise/cache"
ENV MISE_INSTALL_PATH="/usr/local/bin/mise"
ENV PATH="/mise/shims:$PATH"

# Configure Vertex AI for Claude Code
ENV CLAUDE_CODE_USE_VERTEX="1"
ENV CLOUD_ML_REGION="us-east5"
ENV ANTHROPIC_VERTEX_PROJECT_ID="wsh-dev-vertex-wsky"

# Install mise (polyglot runtime manager)
# https://mise.jdx.dev/
RUN curl https://mise.run | sh

# Install Google Cloud SDK
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
  --mount=type=cache,target=/var/lib/apt,sharing=locked \
  rm -f /etc/apt/apt.conf.d/docker-clean && \
  echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache && \
  apt-get update && \
  apt-get install -y --no-install-recommends \
    ca-certificates \
    gnupg2 \
    lsb-release && \
  echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | \
  tee -a /etc/apt/sources.list.d/google-cloud-sdk.list && \
  curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | \
  gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg && \
  apt-get update && \
  apt-get install -y google-cloud-cli

USER agent

# Enable shell integration for agent user
RUN echo 'eval "$(mise activate bash)"' >> /home/agent/.bashrc

# Clone and install dotfiles
RUN git clone https://github.com/tvrmsmith/dotfiles.git /home/agent/dotfiles && \
    /home/agent/dotfiles/install.sh
